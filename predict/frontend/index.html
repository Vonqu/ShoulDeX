<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时角度预测系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #2ed573;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .data-display {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .data-item {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .data-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .data-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.2em;
            margin: 50px 0;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>实时角度预测系统</h1>
            <p>基于LSTM的实时运动角度预测</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="connectionText">连接中...</span>
            </div>
            <div class="status-item">
                <span>预测时间: <span id="predictionTime">--</span> ms</span>
            </div>
            <div class="status-item">
                <span>当前时间: <span id="currentTime">--</span> s</span>
            </div>
            <div class="status-item">
                <span>帧数: <span id="frameCount">--</span></span>
            </div>
        </div>

        <div class="data-display">
            <h3 style="margin-bottom: 15px; color: #2c3e50;">实时预测角度值</h3>
            <div class="data-grid" id="angleGrid">
                <!-- 角度数据将在这里动态生成 -->
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">左肱骨与胸廓角度</div>
                <div class="chart-container">
                    <canvas id="chart1"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">右肱骨与胸廓角度</div>
                <div class="chart-container">
                    <canvas id="chart2"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">左肩胛骨与胸廓角度</div>
                <div class="chart-container">
                    <canvas id="chart3"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">右肩胛骨与胸廓角度</div>
                <div class="chart-container">
                    <canvas id="chart4"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">左锁骨与胸廓角度</div>
                <div class="chart-container">
                    <canvas id="chart5"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">右锁骨与胸廓角度</div>
                <div class="chart-container">
                    <canvas id="chart6"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">左肱骨与左肩胛骨角度</div>
                <div class="chart-container">
                    <canvas id="chart7"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">右肱骨与右肩胛骨角度</div>
                <div class="chart-container">
                    <canvas id="chart8"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">胸廓与髋关节角度</div>
                <div class="chart-container">
                    <canvas id="chart9"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let ws = null;
        let charts = {};
        let isConnected = false;

        // 角度分组定义
        const angleGroups = [
            { name: '左肱骨与胸廓', indices: [0, 1, 2], chartId: 'chart1' },
            { name: '右肱骨与胸廓', indices: [3, 4, 5], chartId: 'chart2' },
            { name: '左肩胛骨与胸廓', indices: [6, 7, 8], chartId: 'chart3' },
            { name: '右肩胛骨与胸廓', indices: [9, 10, 11], chartId: 'chart4' },
            { name: '左锁骨与胸廓', indices: [12, 13, 14], chartId: 'chart5' },
            { name: '右锁骨与胸廓', indices: [15, 16, 17], chartId: 'chart6' },
            { name: '左肱骨与左肩胛骨', indices: [18, 19, 20], chartId: 'chart7' },
            { name: '右肱骨与右肩胛骨', indices: [21, 22, 23], chartId: 'chart8' },
            { name: '胸廓与髋关节', indices: [24, 25, 26], chartId: 'chart9' }
        ];

        // 初始化图表
        function initializeCharts() {
            const colors = ['#FF6384', '#36A2EB', '#FFCE56'];
            const labels = ['X轴', 'Y轴', 'Z轴'];

            angleGroups.forEach((group, groupIndex) => {
                const ctx = document.getElementById(group.chartId).getContext('2d');
                
                charts[group.chartId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: group.indices.map((angleIndex, i) => ({
                            label: labels[i],
                            data: [],
                            borderColor: colors[i],
                            backgroundColor: colors[i] + '20',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: '时间 (帧)'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: '角度 (°)'
                                },
                                min: 0,
                                max: 180
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        animation: {
                            duration: 0
                        }
                    }
                });
            });
        }

        // 初始化角度数据显示
        function initializeAngleGrid() {
            const grid = document.getElementById('angleGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 27; i++) {
                const dataItem = document.createElement('div');
                dataItem.className = 'data-item';
                dataItem.innerHTML = `
                    <div class="data-label">角度 ${i + 1}</div>
                    <div class="data-value" id="angle${i}">--</div>
                `;
                grid.appendChild(dataItem);
            }
        }

        // 更新角度数据显示
        function updateAngleDisplay(angles) {
            angles.forEach((angle, index) => {
                const element = document.getElementById(`angle${index}`);
                if (element) {
                    element.textContent = angle.toFixed(1) + '°';
                }
            });
        }

        // 更新图表数据
        function updateCharts(data) {
            if (!data.history || !data.history.x || !data.history.angles) {
                return;
            }

            const xData = data.history.x;
            const anglesData = data.history.angles;

            angleGroups.forEach(group => {
                const chart = charts[group.chartId];
                if (chart) {
                    // 更新X轴标签
                    chart.data.labels = xData;

                    // 更新每个角度的数据
                    group.indices.forEach((angleIndex, i) => {
                        if (anglesData[angleIndex]) {
                            chart.data.datasets[i].data = anglesData[angleIndex];
                        }
                    });

                    chart.update('none');
                }
            });
        }

        // 更新状态显示
        function updateStatus(data) {
            document.getElementById('predictionTime').textContent = data.prediction_time?.toFixed(2) || '--';
            document.getElementById('currentTime').textContent = data.timestamp?.toFixed(2) || '--';
            document.getElementById('frameCount').textContent = data.frame || '--';
        }

        // 连接WebSocket
        function connectWebSocket() {
            const wsUrl = 'ws://localhost:8766';
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket连接已建立');
                isConnected = true;
                document.getElementById('connectionStatus').classList.add('connected');
                document.getElementById('connectionText').textContent = '已连接';
            };

            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    switch (data.type) {
                        case 'connection':
                            console.log('连接确认:', data.message);
                            break;
                            
                        case 'history':
                            console.log('接收历史数据');
                            updateCharts(data);
                            break;
                            
                        case 'prediction':
                            console.log('接收预测数据:', data.timestamp);
                            updateAngleDisplay(data.angles);
                            updateCharts(data);
                            updateStatus(data);
                            break;
                            
                        case 'heartbeat':
                            // 心跳包，不做处理
                            break;
                            
                        default:
                            console.log('未知消息类型:', data.type);
                    }
                } catch (error) {
                    console.error('解析消息失败:', error);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket连接已关闭');
                isConnected = false;
                document.getElementById('connectionStatus').classList.remove('connected');
                document.getElementById('connectionText').textContent = '连接断开';
                
                // 尝试重新连接
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket错误:', error);
                document.getElementById('connectionText').textContent = '连接错误';
            };
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始初始化...');
            
            // 初始化图表
            initializeCharts();
            
            // 初始化角度数据显示
            initializeAngleGrid();
            
            // 连接WebSocket
            connectWebSocket();
            
            console.log('初始化完成');
        });

        // 页面卸载时关闭连接
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html> 